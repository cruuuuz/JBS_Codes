Function RangetoHTML(rng As Range)

' Changed by Ron de Bruin 28-Oct-2006
' Working in Office 2000-2016

    Dim fso As Object
    Dim ts As Object

    Dim TempFile As String

    Dim TempWB As Workbook



    TempFile = Environ$("temp") & "\" & Format(Now, "dd-mm-yy h-mm-ss") & ".htm"



    'Copy the range and create a new workbook to past the data in

    rng.Copy

    Set TempWB = Workbooks.Add(1)

    With TempWB.Sheets(1)

        .Cells(1).PasteSpecial Paste:=8

        .Cells(1).PasteSpecial xlPasteValues, , False, False

        .Cells(1).PasteSpecial xlPasteFormats, , False, False

        .Cells(1).Select

        Application.CutCopyMode = False

        On Error Resume Next

        .DrawingObjects.Visible = True

        .DrawingObjects.Delete

        On Error GoTo 0

    End With



    'Publish the sheet to a htm file

    With TempWB.PublishObjects.Add(SourceType:=xlSourceRange, Filename:=TempFile, Sheet:=TempWB.Sheets(1).Name, _
         Source:=TempWB.Sheets(1).UsedRange.Address, _
         HtmlType:=xlHtmlStatic)

        .Publish (True)

    End With



    'Read all data from the htm file into RangetoHTML

    Set fso = CreateObject("Scripting.FileSystemObject")

    Set ts = fso.GetFile(TempFile).OpenAsTextStream(1, -2)

    RangetoHTML = ts.readall

    ts.Close

    RangetoHTML = Replace(RangetoHTML, "align=center x:publishsource=", _
                          "align=left x:publishsource=")



    'Close TempWB

    TempWB.Close savechanges:=False



    'Delete the htm file we used in this function

    Kill TempFile



    Set ts = Nothing

    Set fso = Nothing

    Set TempWB = Nothing

End Function




Sub PPT()
Dim pptApp As Object
    Dim pptPres As Object
    Dim pptSlide As Object
    Dim pptShape As Object
    Dim excelApp As Object
    Dim excelWB As Object
    Dim existingPicture As Object
    Dim newPicture As Object
    Dim cellValue As String
Set pptApp = CreateObject("PowerPoint.Application")
Set pptPres = pptApp.Presentations.Open("O:\Cruz\Inteligencia\USA\USDA\Imports\Report\US_Beef_Imports.pptx")
Set excelWB = ThisWorkbook
currentDate = Format(Now(), "yyyy_mm_dd")
'Refresh all linked charts
    For Each Slide In pptPres.Slides
        For Each Shape In Slide.Shapes
            If Shape.HasChart Then
                Set myChart = Shape.Chart
                myChart.ChartData.Activate
                myChart.Refresh
                Set excelWB = myChart.ChartData.Workbook
                Set App = excelWB.Application
            End If
        Next
    Next
    Set myChart = Nothing

'1st Slide
    Set pptSlide = pptPres.Slides(1)
    Set pptShape = pptSlide.Shapes("Subtitle 2")
    cellValue = excelWB.Sheets("PPT").Range("M7").Text
    pptShape.TextFrame.TextRange.Text = cellValue

'2nd Slide
    Set pptSlide = pptPres.Slides(2)
    'comment 1
    cellValue = excelWB.Sheets("PPT").Range("M8").Text
    Set pptShape = pptSlide.Shapes("Comment 1")
    pptShape.TextFrame.TextRange.Text = cellValue
    'comment 2
    Set pptShape = pptSlide.Shapes("Comment 2")
    cellValue = excelWB.Sheets("PPT").Range("Y8").Text
    pptShape.TextFrame.TextRange.Text = cellValue
    'table
    Set existingPicture = pptSlide.Shapes("Picture 1")
    Set excelRange = excelWB.Sheets("PPT").Range("D3:H15")
    excelRange.CopyPicture
    pptSlide.Shapes.PasteSpecial DataType:=ppPasteEnhancedMetafile
    Set newPicture = pptSlide.Shapes(pptSlide.Shapes.Count)
    newPicture.Left = existingPicture.Left
    newPicture.Top = existingPicture.Top
    newPicture.Width = existingPicture.Width
    newPicture.Height = existingPicture.Height
    existingPicture.Delete
    newPicture.Name = "Picture 1"
    
'3rd Slide
    Set pptSlide = pptPres.Slides(3)
    'comment 1
    cellValue = excelWB.Sheets("PPT").Range("M35").Text
    Set pptShape = pptSlide.Shapes("comment 1")
    pptShape.TextFrame.TextRange.Text = cellValue
    'comment 2
    cellValue = excelWB.Sheets("PPT").Range("Y35").Text
    Set pptShape = pptSlide.Shapes("comment 2")
    pptShape.TextFrame.TextRange.Text = cellValue
    
'4th Slide
    Set pptSlide = pptPres.Slides(4)
    'comment 1
    cellValue = excelWB.Sheets("PPT").Range("M62").Text
    Set pptShape = pptSlide.Shapes("comment 1")
    pptShape.TextFrame.TextRange.Text = cellValue
    'comment 2
    cellValue = excelWB.Sheets("PPT").Range("Y62").Text
    Set pptShape = pptSlide.Shapes("comment 2")
    pptShape.TextFrame.TextRange.Text = cellValue

'5th Slide
    Set pptSlide = pptPres.Slides(5)
    'comment 1
    cellValue = excelWB.Sheets("PPT").Range("M88").Text
    Set pptShape = pptSlide.Shapes("comment 1")
    pptShape.TextFrame.TextRange.Text = cellValue
    'comment 2
    cellValue = excelWB.Sheets("PPT").Range("Y88").Text
    Set pptShape = pptSlide.Shapes("comment 2")
    pptShape.TextFrame.TextRange.Text = cellValue

'6th Slide
    Set pptSlide = pptPres.Slides(6)
    'comment 1
    cellValue = excelWB.Sheets("PPT").Range("M114").Text
    Set pptShape = pptSlide.Shapes("comment 1")
    pptShape.TextFrame.TextRange.Text = cellValue
    'comment 2
    cellValue = excelWB.Sheets("PPT").Range("Y114").Text
    Set pptShape = pptSlide.Shapes("comment 2")
    pptShape.TextFrame.TextRange.Text = cellValue
    
'Save ppt
    pptPres.Save
    pptApp.ActivePresentation.SaveAs "O:\Cruz\Inteligencia\USA\USDA\Imports\PDF\US_Beef_Imports_" & currentDate & ".pdf", 32
    
'Clear objects from memory
    Set pptShape = Nothing
    Set pptSlide = Nothing
    Set pptPres = Nothing
    Set pptApp = Nothing
    Set excelWB = Nothing
    Set excelApp = Nothing
    
End Sub
Sub Envia_Grafico()

    Dim objOutlook As Object
    Dim objMailItem As Object
    Dim objRecipient As Object
    Dim objNameSpace As Object
    Dim strCaminho As String
    Dim strNomeArquivo As String
    Dim dtRef As Double
    Dim rngmail, strMail, strCC As String
    
   strDt = Trim(Format(Day(Range("Dtref")), "00")) + "_" + Trim(Format(Month(Range("Dtref")), "00")) + "_" + Trim(Year(Range("Dtref")))
    

        
    Dim rng As Range
    Dim OutApp As Object
    Dim OutMail As Object
    Set rng = Nothing
   
   
   Set rng = Sheets("Graphs_Weekly_Slaughter").Range("rgTable").SpecialCells(xlCellTypeVisible)
     Set OutApp = CreateObject("Outlook.Application")


    ' Define o gr치fico a ser salvo (substitua "Chart 1" pelo nome do seu gr치fico)
    Set chrt = ActiveSheet.ChartObjects("Gr치fico 1")

    ' Define o caminho e o nome do arquivo PNG
    strCaminho = "O:\Cruz\Inteligencia\Karl\1. Australia\Support_Files\" ' Substitua pelo caminho desejado
    strNomeArquivo = "AUS_Weekly_Slaughter_" & Format(Now, "YYYY_MM_DD") & ".png"

    ' Exporta o gr치fico como PNG
    chrt.Chart.Export Filename:=strCaminho & strNomeArquivo, FilterName:="PNG"





    Set OutMail = OutApp.CreateItem(0)
    

   With OutMail
      .To = Range("rgMail_2").Value
      .cc = Range("rgCC").Value
      .htmlbody = "<html><body>Good morning!<br><br>Please find attached the Austrlian weekly cattle slaughter (MLA numbers):<br>" & RangetoHTML(rng) & "<br><img src='" & strCaminho & strNomeArquivo & "'></body></html>"
      .Subject = Range("rgSub").Value
      .Display
   End With

End Sub
